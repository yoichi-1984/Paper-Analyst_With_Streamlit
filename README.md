## paper-analystのまとめ

Streamlitベースの文献分析アプリ「Paper-Analyst」を構成する4つの主要モジュール  
（設定管理、文書読み込み、チャット型Q&A、起動スクリプト）  
の設計と機能を概説します。  
config.pyで定数や表示文言を一元管理し、document_loader.pyでPDF／Word／テキストの各形式を適切に抽出、main.pyでAzure OpenAIを用いた対話型インターフェースを提供、run.pyでアプリを起動する流れをまとめています。  
これにより、複数文書を背景情報として統合的に扱いながら、Web上で質問応答を実現する仕組みが明らかになります。  
  
---  
  
## 各ファイルの詳細  
  
## ファイル: `src2\paper_analyst\config.py`  
  
このファイルは、Streamlit ベースの文献分析アプリ「Paper-Analyst」において  
  
・読み込む文献数や dotenv ファイルのパスなどの定数  
・Azure OpenAI に接続するための環境変数キー名  
・セッションステートの初期値（現在のステータス、選択モデル、読み込んだ文書一覧など）  
・画面上に表示する各種テキスト（ボタンや見出し、警告メッセージなど）  
  
を一元管理する設定ファイルです。これにより、UI 表示やデバッグモード、ドキュメント読み込み、AI チャット開始といったアプリ全体の振る舞いを統一的に制御します。  
  
---  
  
## ファイル: `src2\paper_analyst\document_loader.py`  
  
このファイルは、指定したフォルダ内のドキュメント（PDF／Word（.docx）／テキスト系ファイル）を一括で走査・読み込みし、本文文字列を抽出して「ファイル名＋テキスト」の形式で返すためのユーティリティです。   
config.pyの"MAX_DOCUMENT_CHARS" に従って、大量の文字で構成されている元ファイルは分割してCanvasに挿入されます。
  
・PDF は PyMuPDF でページごとにテキストを取り出し、テキスト情報がなければスキャンPDFの可能性を警告  
・.docx は python-docx で段落を連結   
・.txt/.md/.csv は複数の日本語エンコーディングを順番に試して読み込み  
という具合に、各形式に適した方法でテキスト抽出を行い、同時に読み込み不可やゼロサイズファイルなどの問題を警告メッセージとして収集します。最終的に「読み込んだドキュメント一覧」と「警告一覧」を返却します。  
  
---  
  
## ファイル: `src2\paper_analyst\main.py`  
  
このファイルは、Streamlit 上で動作する「複数の文書を読み込んでコンテキストにしたチャット形式のQ&Aアプリ」を実装しています。主な役割と機能は以下のとおりです。  
  
• モデル／環境設定の読み込み  
  – .env ファイルから Azure OpenAI の API キーやエンドポイント、利用可能なモデル名を取得  
• セッション管理  
  – 会話履歴や読み込んだ文書、選択したモデルの状態を保存／復元／リセット  
  – JSON ファイルとしてダウンロード・アップロード可能  
• 文書ロード  
  – 指定フォルダ内のファイルを一括で読み込み、最大件数制限や読み込み時の警告表示に対応  
• プロンプト管理  
  – YAML からシステムプロンプトを読み込み、ユーザーが編集して開始  
• チャットインターフェース  
  – ユーザー入力と過去メッセージを表示  
  – 読み込んだ文書の一部を選択してコンテキストに組み込み  
  – tiktoken でトークン数を算出し、上限超過のチェック  
  – AzureOpenAI のチャット API をストリーミング呼び出しし、応答を段階的に表示  
  – トークン使用量を都度集計・表示  
• デバッグモード  
  – 実際に API に送られるメッセージ内容を展開表示可能  

要するに、「ユーザーがアップロード／指定した複数の文書を背景情報として、Azure OpenAI チャットモデルに質問し、対話形式で回答を得られる Web アプリケーション」を一つのファイルでまとめています。

---

## ファイル: `src2\paper_analyst\run.py`

このファイルは、パッケージのエントリーポイントとして動作し、同じディレクトリにある `main.py` を Streamlit アプリとして起動するためのラッパースクリプトです。  
具体的には、  
- `run.py` 自身の場所から `main.py` のパスを探し、  
- `python -m streamlit run main.py` コマンドを組み立てて実行し、  
- ファイル未検出時や例外発生時、Ctrl+C（KeyboardInterrupt）による中断を適切にハンドリングします。

---  
  
## CHANGELOG  
すべてのリリース履歴は CHANGELOG.md に記載しています。  
  
## ライセンス  
本ソフトウェアは「Apache License 2.0」に準拠しています。  
  
## Author  
-Yoichi-1984 (yoichi.1984.engineer@gmail.com)  
